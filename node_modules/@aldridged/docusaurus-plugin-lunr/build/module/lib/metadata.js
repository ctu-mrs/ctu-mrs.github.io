import { aliasedSitePath, normalizeUrl, parseMarkdownString } from '@docusaurus/utils';
import fs from 'fs-extra';
import path from 'path';
import removeMd from 'remove-markdown';
import striptags from 'striptags';
function inferVersion(dirName, versions) {
    const maybeVersion = dirName.split('/', 1).shift();
    const inferredVersion = maybeVersion ? maybeVersion.replace(/^version-/, '') : null;
    return inferredVersion && versions.includes(inferredVersion) ? inferredVersion : null;
}
function versionFromSource(dirName, versions) {
    return /^version-/.test(dirName) ? inferVersion(dirName, versions) : 'next';
}
export default async function processMetadata({ source, refDir, context, options, env, }) {
    const { routeBasePath } = options;
    const { siteDir, baseUrl } = context;
    const { versioning } = env;
    const dirName = path.dirname(source);
    const filePath = path.join(refDir, source);
    const fileStringPromise = fs.readFile(filePath, 'utf-8');
    const version = (versioning.enabled) ? versionFromSource(dirName, versioning.versions) : null;
    // The version portion of the url path. Eg: 'next', '1.0.0', and ''
    const versionPath = version && version !== versioning.latestVersion ? version : '';
    const contents = await fileStringPromise;
    const plaintext = removeMd(striptags(contents));
    const { frontMatter = {}, excerpt } = parseMarkdownString(contents);
    const baseID = frontMatter.id || path.basename(source, path.extname(source));
    // tslint:disable-next-line: no-if-statement
    if (baseID.includes('/')) {
        throw new Error('Document id cannot include "/".');
    }
    // tslint:enable no-if-statement
    // Append subdirectory as part of id.
    const id = dirName !== '.' ? `${dirName}/${baseID}` : baseID;
    const title = frontMatter.title || baseID;
    const description = frontMatter.description || excerpt;
    // The last portion of the url path. Eg: 'foo/bar', 'bar'
    const routePath = version && version !== 'next'
        ? id.replace(new RegExp(`^version-${version}/`), '')
        : id;
    const permalink = normalizeUrl([
        baseUrl,
        routeBasePath,
        versionPath,
        routePath,
    ]);
    const metadata = {
        description,
        id,
        permalink,
        plaintext,
        source: aliasedSitePath(filePath, siteDir),
        title,
        version,
    };
    return metadata;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWV0YWRhdGEuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9zcmMvbGliL21ldGFkYXRhLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxlQUFlLEVBQUUsWUFBWSxFQUFFLG1CQUFtQixFQUFFLE1BQU0sbUJBQW1CLENBQUM7QUFDdkYsT0FBTyxFQUFFLE1BQU0sVUFBVSxDQUFDO0FBQzFCLE9BQU8sSUFBSSxNQUFNLE1BQU0sQ0FBQztBQUN4QixPQUFPLFFBQVEsTUFBTSxpQkFBaUIsQ0FBQztBQUN2QyxPQUFPLFNBQVMsTUFBTSxXQUFXLENBQUM7QUFJbEMsU0FBUyxZQUFZLENBQUMsT0FBZSxFQUFFLFFBQStCO0lBQ3BFLE1BQU0sWUFBWSxHQUFHLE9BQU8sQ0FBQyxLQUFLLENBQUMsR0FBRyxFQUFFLENBQUMsQ0FBQyxDQUFDLEtBQUssRUFBRSxDQUFDO0lBQ25ELE1BQU0sZUFBZSxHQUFHLFlBQVksQ0FBQyxDQUFDLENBQUMsWUFBWSxDQUFDLE9BQU8sQ0FBQyxXQUFXLEVBQUUsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQztJQUNwRixPQUFPLGVBQWUsSUFBSSxRQUFRLENBQUMsUUFBUSxDQUFDLGVBQWUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxlQUFlLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQztBQUN4RixDQUFDO0FBRUQsU0FBUyxpQkFBaUIsQ0FBQyxPQUFlLEVBQUUsUUFBK0I7SUFDekUsT0FBTyxXQUFXLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsQ0FBQyxZQUFZLENBQUMsT0FBTyxFQUFFLFFBQVEsQ0FBQyxDQUFDLENBQUMsQ0FBQyxNQUFNLENBQUM7QUFDOUUsQ0FBQztBQUVELE1BQU0sQ0FBQyxPQUFPLENBQUMsS0FBSyxVQUFVLGVBQWUsQ0FBQyxFQUM1QyxNQUFNLEVBQ04sTUFBTSxFQUNOLE9BQU8sRUFDUCxPQUFPLEVBQ1AsR0FBRyxHQUNKO0lB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